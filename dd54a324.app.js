"use strict";angular.module("lformsApp",["ngCookies","ngResource","ngSanitize","ngRoute","ngAnimate","ngMaterial","lformsWidget","angularFileUpload"]).config(["$ariaProvider",function(e){e.config({tabindex:!1,bindRoleForClick:!1})}]).config(["$routeProvider","$locationProvider",function(e,t){e.when("/lforms-fhir-app",{templateUrl:"fhir-app/fhir-app.html",controller:"FhirAppCtrl"}).when("/",{templateUrl:"fhir-app/fhir-app.html",controller:"FhirAppCtrl"}),t.html5Mode(!0)}]);var LFormsUtil=LFormsUtil||{};LFormsUtil.copyToClipboard=function(e){window.getSelection().selectAllChildren(document.getElementById(e)),document.execCommand("Copy")},angular.module("lformsApp").controller("FhirAppContentCtrl",["$scope","$window","$http","$timeout","$routeParams","selectedFormData","$mdDialog","fhirService","userMessages",function(s,e,t,n,i,o,r,l,a){var c="R4";s.initialLoad=!0,s.previewOptions={hideCheckBoxes:!0},s.lfOptions={showQuestionCode:!0,showCodingInstruction:!1,tabOnInputFieldsOnly:!1,showFormHeader:!1},s.fhirResInfo={resId:null,resType:null,resTypeDisplay:null,extensionType:null,questionnaireResId:null,questionnaireName:null},s.userMessages=a,s.valueCleanUp=function(e){for(var t=angular.copy(e),n=0,i=t.itemList.length;n<i;n++)delete t.itemList[n].value;return t},s.saveQRToFhir=function(){$(".spinner").show(),"QuestionnaireResponse"===s.fhirResInfo.resType&&(s.fhirResInfo.resId?s.updateQRToFhir(s.fhirResInfo.extensionType):s.createQRToFhir(s.fhirResInfo.extensionType))},s.deleteFromFhir=function(){$(".spinner").show(),s.fhirResInfo.resId&&l.deleteFhirResource(s.fhirResInfo.resType,s.fhirResInfo.resId)},s.saveAsToFhir=function(e){$(".spinner").show(),"QR"===e?s.createQRToFhir():"SDC-QR"===e&&s.createQRToFhir("SDC")},s.saveDRToFhir=function(){var e=LForms.FHIR.createDiagnosticReport(s.formData,l.getCurrentPatient().resource,!0,"transaction");e?l.handleTransactionBundle(e):console.log("Failed to create a DiagnosticReport. "+JSON.stringify(s.formData))},s.createQRToFhir=function(e){$(".spinner").show();var t="SDC"!==e,n=LForms.Util.getFormFHIRData("QuestionnaireResponse",l.fhirVersion,s.formData,{noExtensions:t,subject:l.getCurrentPatient()});if(n){var i=l.getCurrentPatient();if(i&&(n.subject={reference:"Patient/"+i.id,display:i.name}),delete n.id,s.fhirResInfo.questionnaireResId){var o={id:s.fhirResInfo.questionnaireResId,name:s.fhirResInfo.questionnaireName};l.createQR(n,o,e)}else{var r=s.valueCleanUp(s.formData),a=LForms.Util.getFormFHIRData("Questionnaire",l.fhirVersion,r);a?(delete a.id,l.createQQR(a,n,e)):console.log("Failed to create a Questionnaire. "+JSON.stringify(s.formData))}}else console.log("Failed to create a QuestionnaireResponse. "+JSON.stringify(s.formData))},s.updateQRToFhir=function(e){$(".spinner").show();var t="SDC"!==e;if(s.fhirResInfo.resId&&s.fhirResInfo.questionnaireResId){var n=LForms.Util.getFormFHIRData("QuestionnaireResponse",l.fhirVersion,s.formData,{noExtensions:t});if(n){var i=l.getCurrentPatient();i&&(n.subject={reference:"Patient/"+i.id,display:i.name}),n.questionnaire={reference:"Questionnaire/"+s.fhirResInfo.questionnaireResId},n.id=s.fhirResInfo.resId,l.updateFhirResource("QuestionnaireResponse",n)}else console.log("Failed to update a QuestionnaireResponse. "+JSON.stringify(s.formData))}},s.showHL7Segments=function(e){s.formData&&(s.hl7String=LForms.HL7.toHL7Segments(s.formData),r.show({scope:s,preserveScope:!0,templateUrl:"fhir-app/hl7-dialog.html",parent:angular.element(document.body),targetEvent:e}))},s.showFHIRDiagnosticReport=function(e){if(s.formData){var t=LForms.Util.getFormFHIRData("DiagnosticReport",c,s.formData,{bundleType:"collection"}),n=(t=LForms.FHIR.createDiagnosticReport(s.formData,l.getCurrentPatient().resource,!0,"collection"),JSON.stringify(t,null,2));s.fhirResourceString=n,s.fhirResourceTitle="FHIR DiagnosticReport Resource",r.show({scope:s,preserveScope:!0,templateUrl:"fhir-app/fhir-resource-dialog.html",parent:angular.element(document.body),targetEvent:e})}},s.showOrigFHIRQuestionnaire=function(e){var t=l.getCurrentQuestionnaire();if(t){var n=JSON.stringify(t,null,2);s.fhirResourceString=n,s.fhirResourceTitle="Questionnaire Resource from FHIR Server",r.show({scope:s,preserveScope:!0,templateUrl:"fhir-app/fhir-resource-dialog.html",parent:angular.element(document.body),targetEvent:e})}},s.showFHIRQuestionnaire=function(e){if(s.formData){var t=s.valueCleanUp(s.formData),n=LForms.Util.getFormFHIRData("Questionnaire",c,t,{noExtensions:!0}),i=JSON.stringify(n,null,2);s.fhirResourceString=i,s.fhirResourceTitle="FHIR Questionnaire Resource",r.show({scope:s,preserveScope:!0,templateUrl:"fhir-app/fhir-resource-dialog.html",parent:angular.element(document.body),targetEvent:e})}},s.showFHIRSDCQuestionnaire=function(e){if(s.formData){var t=s.valueCleanUp(s.formData),n=LForms.Util.getFormFHIRData("Questionnaire",c,t),i=JSON.stringify(n,null,2);s.fhirResourceString=i,s.fhirResourceTitle="FHIR SDC Questionnaire Resource",r.show({scope:s,preserveScope:!0,templateUrl:"fhir-app/fhir-resource-dialog.html",parent:angular.element(document.body),targetEvent:e})}},s.showFHIRQuestionnaireResponse=function(e){if(s.formData){var t=LForms.Util.getFormFHIRData("QuestionnaireResponse",c,s.formData,{noExtensions:!0,subject:l.getCurrentPatient()}),n=JSON.stringify(t,null,2);s.fhirResourceString=n,s.fhirResourceTitle="FHIR QuestionnaireResponse Resource",r.show({scope:s,preserveScope:!0,templateUrl:"fhir-app/fhir-resource-dialog.html",parent:angular.element(document.body),targetEvent:e})}},s.showFHIRSDCQuestionnaireResponse=function(e){if(s.formData){var t=LForms.Util.getFormFHIRData("QuestionnaireResponse",c,s.formData,{subject:l.getCurrentPatient()}),n=JSON.stringify(t,null,2);s.fhirResourceString=n,s.fhirResourceTitle="FHIR SDC QuestionnaireResponse Resource",r.show({scope:s,preserveScope:!0,templateUrl:"fhir-app/fhir-resource-dialog.html",parent:angular.element(document.body),targetEvent:e})}},s.closeDialog=function(){r.hide()},s.copyToClipboard=function(e){LFormsUtil.copyToClipboard(e)},s.$on("LF_FHIR_RESOURCE_CREATED",function(e,t){s.fhirResInfo.resId=t.resId,s.fhirResInfo.resType=t.resType,t.qResId&&(s.fhirResInfo.questionnaireResId=t.qResId,s.fhirResInfo.questionnaireName=t.qName),s.fhirResInfo.extensionType=t.extensionType,"QuestionnaireResponse"===t.resType&&t.extensionType?s.fhirResInfo.resTypeDisplay=t.resType+" ("+t.extensionType+")":s.fhirResInfo.resTypeDisplay=t.resType,$(".spinner").hide()}),s.$on("LF_FHIR_RESOURCE_DELETED",function(e,t){o.setFormData(null),s.initialLoad=!0,s.$apply(),$(".spinner").hide()}),s.$on("LF_NEW_DATA",function(){var e=o.getFormData();e&&(e.templateOptions.showFormHeader=!1),s.fhirResInfo=o.getFhirResInfo(),s.formData=e,s.initialLoad&&(s.initialLoad=!1),$(".spinner").hide()})}]),angular.module("lformsApp").controller("NavBarCtrl",["$scope","$http","$mdDialog","selectedFormData","fhirService","FileUploader","userMessages","$timeout",function(g,e,t,s,h,n,l,r){function c(){for(var e=Object.keys(l),t=0,n=e.length;t<n;++t)delete l[e[t]]}g.search={},g.uploader=new n({removeAfterUpload:!0}),g.listSavedQR=null,g.listSavedQ=null,g.formSelected={},g.obrItems=[{question:"Effective Date",questionCode:"date_done",dataType:"DT",answers:"",_answerRequired:!0,answerCardinality:{min:"1",max:"1"},displayControl:{colCSS:[{name:"width",value:"100%"},{name:"min-width",value:"4em"}]}}],g.loadFromFile=function(){document.querySelector("#inputAnchor").click()},g.uploader.onAfterAddingFile=function(e){s.setFormData(null),r(function(){c()});var t=new FileReader;t.onload=function(e){try{var t=JSON.parse(e.target.result)}catch(e){r(function(){l.error=e})}if(t)if(t.resourceType&&"Questionnaire"===t.resourceType){var n;try{var i=LForms.Util.detectFHIRVersion(t);if(!i){i=LForms.Util.guessFHIRVersion(t);var o='specified via meta.profile (see documentation for versioning <a href="http://build.fhir.org/versioning.html#mp-version">resources</a> and <a href="https://www.hl7.org/fhir/references.html#canonical">canonical URLs</a>).</p><p>Example 1:  http://hl7.org/fhir/3.5/StructureDefinition/Questionnaire (for Questionnaire version 3.5).<br>Example 2:  http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire|3.5.0  (for SDC Questionnaire version 3.5).</p>';r(i?function(){l.htmlWarning="<p>Warning:  Assuming this resource is for FHIR version "+i+".To avoid this warning, please make sure the FHIR version is "+o}:function(){l.htmlError="<p>Could not determine the FHIR version for this resource.  Please make sure it is "+o})}console.log("fhirVersion for uploaded Questionnaire = "+i),i=LForms.Util.validateFHIRVersion(i),n=LForms.Util.convertFHIRQuestionnaireToLForms(t,i)}catch(e){r(function(){l.error=e})}n&&r(function(){s.setFormData(new LForms.LFormsData(n))})}else r(function(){s.setFormData(new LForms.LFormsData(t))})},t.readAsText(e._file),$("#inputAnchor")[0].value=""},g.pagingLinks={Questionnaire:{previous:null,next:null},QuestionnaireResponse:{previous:null,next:null}},g.hasPagingLink=function(e,t){return g.pagingLinks[e][t]},g.getPage=function(e,t){var n=g.pagingLinks[e][t];n&&h.getPage(e,t,n)},g.processPagingLinks=function(e,t){for(var n={previous:null,next:null},i=0,o=t.length;i<o;i++){var r=t[i];"previous"!==r.relation&&"next"!==r.relation||(n[r.relation]=r.url)}g.pagingLinks[e]=n},g.showSavedQQR=function(e,t){if(t&&"QuestionnaireResponse"===t.resType){$(".spinner").show(),c(),s.setFormData(null),g.formSelected={groupIndex:1,formIndex:e};var n,i=h.fhirVersion;try{var o=LForms.Util.convertFHIRQuestionnaireToLForms(t.questionnaire,i),r=new LForms.LFormsData(o).getFormData();n=LForms.Util.mergeFHIRDataIntoLForms("QuestionnaireResponse",t.questionnaireresponse,r,i)}catch(e){console.error(e),l.error="Sorry.  Could not process that QuestionnaireResponse.  See the console for details."}if(n){var a={resId:t.resId,resType:t.resType,resTypeDisplay:t.resTypeDisplay,extensionType:t.extensionType,questionnaireResId:t.questionnaire.id,questionnaireName:t.questionnaire.name};s.setFormData(new LForms.LFormsData(n),a),h.setCurrentQuestionnaire(t.questionnaire)}}},g.showSavedQuestionnaire=function(i,o){o&&"Questionnaire"===o.resType&&($(".spinner").show(),c(),s.setFormData(null),r(function(){g.formSelected={groupIndex:2,formIndex:i};try{var e=LForms.Util.convertFHIRQuestionnaireToLForms(o.questionnaire,h.fhirVersion)}catch(e){l.error=e}if(!l.error){var t=new LForms.LFormsData(e).getFormData(),n={resId:null,resType:null,resTypeDisplay:null,extensionType:null,questionnaireResId:o.resId,questionnaireName:o.questionnaire.name};s.setFormData(new LForms.LFormsData(t),n),h.setCurrentQuestionnaire(o.questionnaire)}},10))},g.isSelected=function(e,t){var n="";return g.formSelected&&g.formSelected.groupIndex===e&&g.formSelected.formIndex===t&&(n="active"),n};var v="MM/dd/yyyy HH:mm:ss";g.$on("LF_FHIR_QUESTIONNAIRERESPONSE_LIST",function(e,t,n){if(g.listSavedQR=[],!(g.listSavedQRError=n)&&t&&0<t.total){for(var i=0,o=t.entry.length;i<o;i++){var r=t.entry[i].resource;if("QuestionnaireResponse"===r.resourceType){var a;r.meta&&r.meta.lastUpdated?a=new Date(r.meta.lastUpdated).toString(v):r.authored&&(a=new Date(r.authored).toString(v));var s=null,l=null,c=r.questionnaire&&r.questionnaire.reference?r.questionnaire.reference:r.questionnaire;if(c){var d=c.slice("Questionnaire".length+1);s=h.findQuestionnaire(t,d)}if(s){l=s.name;var u=new RegExp("http://hl7.org/fhir/u./sdc/StructureDefinition/sdc-questionnaire\\|(\\d+.?\\d+)"),p=null;if(r.meta&&r.meta.profile)for(var m=0,f=r.meta.profile.length;m<f;m++)r.meta.profile[m].match(u)&&(p="SDC");g.listSavedQR.push({resId:r.id,resName:l,updatedAt:a,resType:"QuestionnaireResponse",questionnaire:s,questionnaireresponse:r,extensionType:p,resTypeDisplay:p?"QuestionnaireResponse (SDC)":"QuestionnaireResponse"})}}}g.processPagingLinks("QuestionnaireResponse",t.link),$(".spinner").hide()}g.$apply()}),g.$on("LF_FHIR_QUESTIONNAIRE_LIST",function(e,t,n){if(g.listSavedQ=[],g.listSavedQError=n,t&&0<t.total){for(var i=0,o=t.entry.length;i<o;i++){var r,a=t.entry[i].resource;a.meta&&a.meta.lastUpdated?r=new Date(a.meta.lastUpdated).toString(v):a.date&&(r=new Date(a.date).toString(v)),g.listSavedQ.push({resId:a.id,resName:a.name,updatedAt:r,resType:"Questionnaire",questionnaire:a,resTypeDisplay:"Questionnaire"})}g.processPagingLinks("Questionnaire",t.link)}g.$apply(),$(".spinner").hide()}),g.$on("LF_FHIR_RESOURCE_DELETED",function(e,t){var n=h.getCurrentPatient();h.getAllQRByPatientId(n.id),h.getAllQ(),g.formSelected={},$(".spinner").hide()}),g.$on("LF_FHIR_RESOURCE_CREATED",function(e,t){var n=h.getCurrentPatient();h.getAllQRByPatientId(n.id),h.getAllQ(),g.formSelected={groupIndex:1,formIndex:0},$(".spinner").hide()}),g.$on("LF_FHIR_RESOURCE_UPDATED",function(e,t){var n=h.getCurrentPatient();h.getAllQRByPatientId(n.id),h.getAllQ(),g.formSelected={groupIndex:1,formIndex:0},$(".spinner").hide()}),g.selectedQuestionnaire=null,g.showQuestionnairePicker=function(e){g.selectedQuestionnaireInDialog=null,t.show({scope:g,preserveScope:!0,templateUrl:"fhir-app/questionnaire-select-dialog.html",parent:angular.element(document.body),targetEvent:e,controller:["$scope","$mdDialog",function(t,n){t.dialogTitle="Questionnaire Picker",t.dialogLabel="Choose a Questionnaire",t.dialogHint="Search for Questionnaires by name",t.closeDialog=function(){t.selectedQuestionnaireInDialog=null,n.hide()},t.confirmAndCloseDialog=function(){t.selectedQuestionnaire=angular.copy(t.selectedQuestionnaireInDialog.resource);var e=LForms.Util.convertFHIRQuestionnaireToLForms(t.selectedQuestionnaire);s.setFormData(new LForms.LFormsData(e)),h.setCurrentQuestionnaire(t.selectedQuestionnaire),t.selectedQuestionnaireInDialog=null,n.hide()}}]})},g.differentQuestionnaire=function(e,t){return e&&t&&e.id!==t.id},g.searchQuestionnaireByName=function(e){return h.searchQuestionnaireByName(e)}}]),angular.module("lformsApp").controller("FhirAppCtrl",["$scope","$timeout","$http","$location","$mdDialog","fhirService",function(c,e,t,n,i,o){c.getCurrentPatient=function(){return o.getCurrentPatient()},c.getPatientName=function(){return o.getPatientName()},c.getPatientGender=function(){return o.getCurrentPatient().gender},c.getPatientDob=function(){return o.getCurrentPatient().birthDate},c.getPatientPhone=function(){return o.getPatientPhoneNumber()},e(function(){c.establishFHIRContext()},1e3),c.establishFHIRContext=function(){var e=n.search().server;e?(o.setNonSmartServer(e),c.showPatientPicker()):o.getSmartConnection()||o.smartConnectionInProgress()||o.requestSmartConnection(function(e){var t;e?o.getSmartConnection().patient.read().then(function(e){o.setCurrentPatient(e),o.getAllQRByPatientId(e.id),o.getAllQ(),c.$apply()}):(console.log("Could not establish a SMART connection."),(t=n.search().server)?(o.setNonSmartServer(t),c.showPatientPicker()):c.showFHIRServerPicker())})},c.showPatientPicker=function(e){c.selectedPatientInDialog=null,i.show({scope:c,preserveScope:!0,templateUrl:"fhir-app/patient-select-dialog.html",parent:angular.element(document.body),targetEvent:e,controller:["$scope","$mdDialog",function(t,n){t.dialogTitle="Patient Picker",t.dialogLabel="Choose a Patient",t.dialogHint="Search for patients by name",t.closeDialog=function(){t.selectedPatientInDialog=null,n.hide()},t.confirmAndCloseDialog=function(){var e=t.selectedPatientInDialog.resource;e&&(o.setCurrentPatient(e),o.getAllQRByPatientId(e.id),o.getAllQ()),t.selectedPatientInDialog=null,n.hide()}}]})},c.showFHIRServerPicker=function(e){c.selectedServerInDialog=null,i.show({scope:c,preserveScope:!0,templateUrl:"fhir-app/fhir-server-select-dialog.html",parent:angular.element(document.body),targetEvent:e,controller:["$scope","$mdDialog",function(n,i){n.dialogTitle="FHIR Server Needed",n.dialogLabel="Select or Enter the base URL of a FHIR Server",n.fhirServerListOpts={listItems:[{text:"https://launch.smarthealthit.org/v/r3/fhir"},{text:"https://lforms-fhir.nlm.nih.gov/baseDstu3"},{text:"https://lforms-fhir.nlm.nih.gov/baseR4"},{text:"http://test.fhir.org/r4"}]},n.closeDialog=function(){n.selectedServerInDialog=null,i.hide()},n.confirmAndCloseDialog=function(){var t=n.selectedServerInDialog&&n.selectedServerInDialog.text;t&&(n.showWaitMsg("Contacting FHIR server.  Please wait..."),o.setNonSmartServer(t,function(e){i.hide(),e?n.showPatientPicker():n.showErrorMsg("Could not establish communication with the FHIR server at "+t+".")})),n.selectedServerInDialog=null,i.hide()}}]})},c.$on("OP_FAILED",function(e,t){$(".spinner").hide();var n=t.errInfo;if(n&&n.error&&n.error.responseJSON&&n.error.responseJSON.issue){for(var i=n.error.responseJSON.issue,o='Unable to "'+t.operation+'" '+t.resType+".",r=!1,a=0,s=i.length;a<s&&!r;++a){var l=i[a];("error"==l.severity||"fatal"==l.severity)&&l.details&&l.details.text&&(o=o+"\n"+l.details.text,r=!0)}console.log(o),c.showErrorMsg(o)}}),c.showErrorMsg=function(e){i.show(i.alert().parent(angular.element(document.body)).clickOutsideToClose(!0).title("Error").textContent(e).ariaLabel("Error Dialog").ok("OK"))},c.showWaitMsg=function(e){i.show(i.alert().parent(angular.element(document.body)).clickOutsideToClose(!0).title("Please Wait").textContent(e).ariaLabel("Please Wait Dialog").ok("OK"))},c.searchPatientByName=function(e){return o.searchPatientByName(e)}}]);var fb=angular.module("lformsApp");fb.service("fhirService",["$rootScope","$q","$http","$window",function(r,e,t,a){var s=this;function l(e,t,n){r.$broadcast("OP_FAILED",{resType:e,operation:t,errInfo:n})}s.currentPatient=null,s.connection=null,s.fhir=null,s.currentQuestionnaire=null,s.requestSmartConnection=function(t){s.connection=null,s._connectionInProgress||(s._connectionInProgress=!0,FHIR.oauth2.ready(function(e){s.setSmartConnection(e),s._connectionInProgress=!1,t(!0)},function(){t(!1)}))},s.smartConnectionInProgress=function(){return s._connectionInProgress},s.setSmartConnection=function(n){s.connection=n,s.fhir=n.patient.api,LForms.Util.setFHIRContext({getCurrent:function(e,t){0<=e.indexOf("Patient")&&n.patient.read().then(function(e){t(e)})},getFHIRAPI:function(){return s.fhir}}),LForms.Util.getServerFHIRReleaseID(function(e){s.fhirVersion=e})},s.setNonSmartServer=function(e,t){try{s.fhir=FHIR.client({serviceUrl:e}).api,s.nonSmartContext={baseURL:e,getCurrent:function(e,t){0<=e.indexOf("Patient")&&setTimeout(function(){t(s.currentPatient)})},getFHIRAPI:function(){return s.fhir}},LForms.Util.setFHIRContext(s.nonSmartContext),LForms.Util.getServerFHIRReleaseID(function(e){void 0!==e?(s.fhirVersion=e,t(!0)):t(!1)})}catch(e){throw t(!1),e}},s.getSmartConnection=function(){return s.connection},s.setCurrentQuestionnaire=function(e){s.currentQuestionnaire=e,r.$broadcast("LF_FHIR_QUESTIONNAIRE_SELECTED",{resource:e})},s.getCurrentQuestionnaire=function(){return s.currentQuestionnaire},s.setCurrentPatient=function(e){s.currentPatient=e,s.nonSmartContext&&(s.fhir=FHIR.client({serviceUrl:s.nonSmartContext.baseURL,patientId:e.id}).patient.api)},s.getCurrentPatient=function(){return s.currentPatient},s.getPatientName=function(e){var t=e||s.currentPatient,n="";return t&&t.name&&0<t.name.length&&(t.name[0].given&&t.name[0].family?n=t.name[0].given[0]+" "+t.name[0].family:t.name[0].family?n=t.name[0].family:t.name[0].given&&(n=t.name[0].given[0])),n},s.getPatientPhoneNumber=function(e){var t=e||s.currentPatient,n="";if(t&&t.telecom)for(var i=0,o=t.telecom.length;i<o;i++)if("phone"===t.telecom[i].system&&t.telecom[i].value){n=t.telecom[i].use?t.telecom[i].use+": "+t.telecom[i].value:t.telecom[i].value;break}return n},s.getPage=function(t,e,n){var i,o=a.location.origin+"/fhir-api?";n=n.replace(/^.*\/baseDstu3\?/,o);"next"===e?i=s.fhir.nextPage:"previous"===e&&(i=s.fhir.prevPage),i({bundle:{resourceType:"Bundle",type:"searchset",link:[{relation:e,url:n}]}}).then(function(e){"Questionnaire"===t?r.$broadcast("LF_FHIR_QUESTIONNAIRE_LIST",e.data):"QuestionnaireResponse"===t&&r.$broadcast("LF_FHIR_QUESTIONNAIRERESPONSE_LIST",e.data)},function(e){console.log(e)})},s.searchPatientByName=function(e){return s.fhir.search({type:"Patient",query:{name:e},headers:{"Cache-Control":"no-cache"}}).then(function(e){var t=[];if(e&&e.data.entry)for(var n=0,i=e.data.entry.length;n<i;n++){var o=e.data.entry[n].resource;t.push({name:s.getPatientName(o),gender:o.gender,dob:o.birthDate,phone:s.getPatientPhoneNumber(o),id:o.id,resource:o})}return t},function(e){console.log(e)})},s.searchQuestionnaireByName=function(e){return s.fhir.search({type:"Questionnaire",query:{name:e},headers:{"Cache-Control":"no-cache"}}).then(function(e){var t=[];if(e&&e.data.entry)for(var n=0,i=e.data.entry.length;n<i;n++){var o=e.data.entry[n].resource;t.push({name:o.name,status:o.status,id:o.id,resource:o})}return t},function(e){console.log(e)})},s.getFhirResourceById=function(t,n){s.fhir.read({type:t,id:n}).then(function(e){r.$broadcast("LF_FHIR_RESOURCE",{resType:t,resource:e.data,resId:n})},function(e){console.log(e)})},s.getMergedQQR=function(e,t){s.fhir.search({type:e,query:{_id:t,_include:"QuestionnaireResponse:questionnaire"},headers:{"Cache-Control":"no-cache"}}).then(function(e){var t={qResource:null,qrResource:null},n=e.data.entry.length;if(0===n);else if(1===n||2===n)for(var i=0;i<n;i++){var o=e.data.entry[i].resource;"QuestionnaireResponse"===o.resourceType?t.qrResource=o:"Questionnaire"===o.resourceType&&(t.qResource=o)}r.$broadcast("LF_FHIR_MERGED_QQR",t)},function(e){console.log(e)})},s.createQR=function(e,t,n){var i=t.id;"STU3"===s.fhirVersion?e.questionnaire={reference:"Questionnaire/"+i}:e.questionnaire="Questionnaire/"+i,s.fhir.create({resource:e}).then(function(e){r.$broadcast("LF_FHIR_RESOURCE_CREATED",{resType:"QuestionnaireResponse",resource:e.data,resId:e.data.id,qResId:i,qName:t.name,extensionType:n})},function(e){console.log(e),l("QuestionnaireResponse","create",e)})},s.createQQR=function(i,o,r){var e={identifier:"http://loinc.org|"+i.identifier[0].value};s.fhir.search({type:"Questionnaire",query:e,headers:{"Cache-Control":"no-cache"}}).then(function(e){var t=e.data;if(0<(t.entry&&t.entry.length||0)){var n=t.entry[0].resource;s.createQR(o,n,r)}else s.fhir.create({resource:i}).then(function(e){s.createQR(o,e.data,r)},function(e){console.log(e),l("Questionnaire","create",e)})},function(e){console.log(e)})},s.updateFhirResource=function(t,n){s.fhir.update({resource:n}).then(function(e){r.$broadcast("LF_FHIR_RESOURCE_UPDATED",{resType:t,resource:e.data,resId:n.id})},function(e){console.log(e)})},s.deleteFhirResource=function(t,n){s.fhir.delete({type:t,id:n}).then(function(e){r.$broadcast("LF_FHIR_RESOURCE_DELETED",{resType:t,resource:null,resId:n})},function(e){console.log(e)})},s.getDRAndObxBundle=function(e,t){s.fhir.search({type:"DiagnosticReport",query:{_id:t,_include:"DiagnosticReport:result"},headers:{"Cache-Control":"no-cache"}}).then(function(e){r.$broadcast("LF_FHIR_DR_OBX_BUNDLE",e.data)},function(e){console.log(e)})},s.handleTransactionBundle=function(e){s.fhir.transaction({bundle:e}).then(function(e){console.log("transaction succeeded"),console.log(e)},function(){console.log(response)})},s.getAllQRByPatientId=function(e){s.fhir.search({type:"QuestionnaireResponse",query:{subject:"Patient/"+e,_include:"QuestionnaireResponse:questionnaire",_sort:"-_lastUpdated",_count:10},headers:{"Cache-Control":"no-cache"}}).then(function(e){r.$broadcast("LF_FHIR_QUESTIONNAIRERESPONSE_LIST",e.data)},function(e){r.$broadcast("LF_FHIR_QUESTIONNAIRERESPONSE_LIST",null,e),console.log(e)})},s.findQuestionnaire=function(e,t){var n=null;if(e)for(var i=0,o=e.entry.length;i<o;i++){var r=e.entry[i].resource;if("Questionnaire"===r.resourceType&&r.id===t){n=r;break}}return n},s.getAllQ=function(){s.fhir.search({type:"Questionnaire",query:{_sort:"-_lastUpdated",_count:10},headers:{"Cache-Control":"no-cache"}}).then(function(e){r.$broadcast("LF_FHIR_QUESTIONNAIRE_LIST",e.data)},function(e){r.$broadcast("LF_FHIR_QUESTIONNAIRE_LIST",null,e),console.log(e)})}}]),angular.module("lformsApp").service("selectedFormData",["$rootScope",function(n){var i={lfData:null,fhirResInfo:{resId:null,resType:null,resTypeDisplay:null,extensionType:null,questionnaireResId:null,questionnaireName:null}};return{getFormData:function(){return i.lfData},getFhirResInfo:function(){return i.fhirResInfo},getFhirResourceId:function(){return i.fhirResInfo.resId},getFhirResourceType:function(){return i.fhirResInfo.resType},setFormData:function(e,t){i.lfData=e,i.fhirResInfo=t||{resId:null,resType:null,resTypeDisplay:null,extensionType:null,questionnaireResId:null,questionnaireName:null},n.$broadcast("LF_NEW_DATA")}}}]),angular.module("lformsApp").service("userMessages",["$rootScope",function(e){return{}}]),angular.module("lformsApp").run(["$templateCache",function(e){e.put("fhir-app/fhir-app-content.html",'<div class=demo-app ng-controller=FhirAppContentCtrl>\x3c!--<p class="status-bar" ng-if="formData">--\x3e\x3c!--<span class="status-label" flex="50">--\x3e\x3c!--<span class="">Resource Type:</span>--\x3e\x3c!--<span class="text-primary">{{fhirResInfo.resTypeDisplay}}</span>--\x3e\x3c!--</span>--\x3e\x3c!--<span class="status-label" flex="50">--\x3e\x3c!--<span class="">Resource ID:</span>--\x3e\x3c!--<span class="text-primary">{{fhirResInfo.resId}}</span>--\x3e\x3c!--</span>--\x3e\x3c!--</p>--\x3e<div class="btn-group btn-group-sm" role=group ng-if=formData><button ng-if="formData && fhirResInfo.resId" type=button class="btn btn-primary" ng-click=saveQRToFhir() id=btn-save data-toggle=tooltip data-placement=bottom title="Save/Update the form data as a FHIR resource to the selected FHIR server."><span class="glyphicon glyphicon-cloud-upload"></span> <span>Save</span></button> <button ng-if="formData && fhirResInfo.resId" type=button class="btn btn-primary" ng-click=deleteFromFhir() id=btn-delete data-toggle=tooltip data-placement=bottom title="Delete the FHIR resource from the selected FHIR server."><span class="glyphicon glyphicon-trash"></span> <span>Delete</span></button></div><div class="btn-group btn-group-sm" role=group ng-if=formData><button type=button class="btn dropdown-toggle btn-primary" data-toggle=dropdown aria-haspopup=true aria-expanded=false id=btn-save-as data-toggle=tooltip data-placement=bottom title="Save the form data as a \'new\' FHIR resource to the selected FHIR server."><span class="glyphicon glyphicon-share"></span> <span>Save As ... </span><span class=caret></span></button><ul class=dropdown-menu>\x3c!--<li><a href="#" class="" id="btn-save-qr" ng-click="saveAsToFhir(\'QR\')">FHIR QuestionnaireResponse</a></li>--\x3e<li><a href=# id=btn-save-sdc-qr ng-click="saveAsToFhir(\'SDC-QR\')">FHIR QuestionnaireResponse (SDC)</a></li>\x3c!--<li><a href="#" class="" ng-click="saveAsToFhir(\'DR\')">FHIR DiagnosticReport</a></li>--\x3e</ul></div><div class="btn-group btn-group-sm" role=group ng-if=formData><button type=button class="btn dropdown-toggle btn-primary" data-toggle=dropdown aria-haspopup=true aria-expanded=false id=btn-show-as data-toggle=tooltip data-placement=bottom title="Show\n     the form data as a FHIR resource in a popup window."><span class="glyphicon glyphicon-modal-window"></span> <span>Show As ... </span><span class=caret></span></button><ul class=dropdown-menu><li ng-if=fhirResInfo.questionnaireResId><a id=show-q-from-server href=# ng-click=showOrigFHIRQuestionnaire()>FHIR Questionnaire from Server</a></li><li ng-if=fhirResInfo.questionnaireResId role=separator class=divider></li>\x3c!--<li><a id="show-q" href="#" class="" ng-click="showFHIRQuestionnaire()">FHIR Questionnaire</a></li>--\x3e\x3c!--<li><a id="show-qr" href="#" class="" ng-click="showFHIRQuestionnaireResponse()">FHIR QuestionnaireResponse</a></li>--\x3e\x3c!--<li role="separator" class="divider"></li>--\x3e<li><a id=show-sdc-q href=# ng-click=showFHIRSDCQuestionnaire()>FHIR Questionnaire (SDC)</a></li><li><a id=show-sdc-qr href=# ng-click=showFHIRSDCQuestionnaireResponse()>FHIR QuestionnaireResponse (SDC)</a></li>\x3c!--<li role="separator" class="divider"></li>--\x3e\x3c!--<li><a href="#" class="" ng-click="showFHIRDiagnosticReport()">FHIR DiagnosticReport</a></li>--\x3e\x3c!--<li role="separator" class="divider"></li>--\x3e\x3c!--<li><a href="#" class="" ng-click="showHL7Segments()">HL7 v2 Message</a></li>--\x3e</ul></div><div ng-if=initialLoad ng-include="\'initial.html\'"></div><div ng-if=userMessages.error class=error>{{userMessages.error}}</div><div ng-if=userMessages.htmlError class=error ng-bind-html=userMessages.htmlError></div><div ng-if=userMessages.htmlWarning class=warning ng-bind-html=userMessages.htmlWarning></div><div ng-if="!initialLoad && !formData && !userMessages.error &&\n    !userMessages.htmlError" ng-include="\'loading.html\'"></div><lforms lf-data=formData lf-options=lfOptions></lforms>\x3c!-- inline templates. these could be in template files too. --\x3e<script type=text/ng-template id=initial.html><div class="loading initial">\n      <span>Please select a FHIR resource or upload from file.</span>\n    </div><\/script><script type=text/ng-template id=loading.html><div class="loading">\n      <span>Loading...</span>\n    </div><\/script>\x3c!-- end of inline templates --\x3e</div>'),e.put("fhir-app/fhir-app-navbar.html",'<div ng-controller=NavBarCtrl><div class="panel panel-default"><div class=panel-heading><div class=panel-title>Saved QuestionnaireResponses:</div></div><div class=panel-body><div ng-if=listSavedQRError>Unable to retrieve saved QuestionnaireResponses.</div><div ng-if="!listSavedQRError && !listSavedQR">Loading QuestionnaireResponses from server...</div><div ng-if="!listSavedQRError && listSavedQR && listSavedQR.length==0">No saved QuestionnaireResponse resources were found for this patient.</div><div ng-if="listSavedQR && listSavedQR.length>0" id=qrList class=list-group><a href=# class="list-group-item {{isSelected(1, $index)}}" ng-repeat="p in listSavedQR" role=presentation id={{p.resId}} ng-click="showSavedQQR($index, p)"><p class=form-name>{{p.resName}}</p><p class=res-type ng-if=p.extensionType>{{p.resTypeDisplay}}</p><p class=last-updated>{{p.updatedAt}}</p></a><div class="btn-group btn-group-justified" role=group><a role=button type=button class="btn btn-default btn-sm glyphicon glyphicon-chevron-left" ng-disabled="!hasPagingLink(\'QuestionnaireResponse\',\'previous\')" ng-click="getPage(\'QuestionnaireResponse\', \'previous\')"></a> <a role=button type=button class="btn btn-default btn-sm glyphicon glyphicon-chevron-right" ng-disabled="!hasPagingLink(\'QuestionnaireResponse\',\'next\')" ng-click="getPage(\'QuestionnaireResponse\', \'next\')"></a></div></div></div></div><div class="panel panel-default"><div class=panel-heading><div class=panel-title>Available Questionnaires:</div></div><div class=panel-body id=qListContainer><div ng-if=listSavedQError>Unable to retrieve saved Questionnaires.</div><div ng-if="!listSavedQError && !listSavedQ">Loading Questionnaires from server...</div><div ng-if="!listSavedQError && listSavedQ && listSavedQ.length==0">No saved Questionnaire resources were found. Try uploading one.</div><div ng-if="listSavedQ && listSavedQ.length>0" id=qList class=list-group><a href=# class="list-group-item {{isSelected(2, $index)}}" ng-repeat="p in listSavedQ" role=presentation id={{p.resId}} ng-click="showSavedQuestionnaire($index, p)"><p class=form-name>{{p.resName}}</p><p class=last-updated>{{p.updatedAt}}</p></a><div class="btn-group btn-group-justified" role=group><a role=button type=button class="btn btn-default btn-sm glyphicon glyphicon-chevron-left" ng-disabled="!hasPagingLink(\'Questionnaire\',\'previous\')" ng-click="getPage(\'Questionnaire\', \'previous\')"></a> <a role=button type=button class="btn btn-default btn-sm glyphicon glyphicon-chevron-right" ng-disabled="!hasPagingLink(\'Questionnaire\',\'next\')" ng-click="getPage(\'Questionnaire\', \'next\')"></a></div><div class="btn-group btn-group-justified" role=group><a role=button type=button class="btn btn-default btn-sm btn-success" ng-click=showQuestionnairePicker($event) title="Choose a Questionnaire from the FHIR server."><span class="glyphicon glyphicon-search"></span><span class=lf-nav-button>Search</span></a></div></div></div></div><div class="panel panel-default">\x3c!--<div class="panel-heading">--\x3e\x3c!--<div class="panel-title">--\x3e\x3c!--Upload From File:--\x3e\x3c!--</div>--\x3e\x3c!--</div>--\x3e<div class=panel-body><input type=file id=inputAnchor nv-file-select uploader=uploader class=hide><div class="btn-group btn-group-justified" role=group><a id=upload role=button type=button class="btn btn-default btn-sm btn-success" ng-click=loadFromFile() title="Upload a file."><span class="glyphicon glyphicon-upload"></span><span class=lf-nav-button>Upload</span></a></div><p>If you do not have a Questionnaire of your own to upload, you can try downloading one of our <a href=https://raw.githubusercontent.com/lhncbc/lforms-fhir-app/master/e2e-tests/data/R4/weight-height-questionnaire.json target=_blank rel="noopener noreferrer" id=sampleQ>samples</a> (saving it to file, and then uploading it here).</p></div></div></div>'),e.put("fhir-app/fhir-app.html",'\x3c!-- page header --\x3e<div id=header><a href=http://lhncbc.nlm.nih.gov title="Lister Hill Center" id=logo><img src=assets/images/lhncbc.jpg alt="Lister Hill Center"></a><div id=siteNameBox><span id=siteName>SDC Questionnaire App</span><br></div><div id=tagLine>An open-source app for Structured Data Capture Questionnaires, powered by the <a target=_blank rel=noopener href=https://lhcforms.nlm.nih.gov>LHC-Forms</a> form rendering widget</div><div id=version>Version: <a target=_blank rel="noopener noreferrer" href=https://github.com/lhncbc/lforms-fhir-app/blob/master/CHANGELOG.md>0.9.0</a></div></div>\x3c!-- end page header --\x3e<div><md-toolbar class=lf-patient><div class=md-toolbar-tools><span class="glyphicon glyphicon-user"></span> <span ng-if=getCurrentPatient() flex="" class=lf-patient-info><div id=ptName class="col-xs-6 col-md-3">Name: {{getPatientName()}}</div><div class="col-xs-6 col-md-3">Gender: {{getPatientGender()}}</div><div class="col-xs-6 col-md-3">DoB: {{getPatientDob()}}</div><div class="col-xs-6 col-md-3">Phone: {{getPatientPhone()}}</div></span></div></md-toolbar><md-content><div class=lf-content><div class="col-md-3 form-nav" ng-include="\'fhir-app/fhir-app-navbar.html\'"></div><div class="col-md-9 form-content" ng-include="\'fhir-app/fhir-app-content.html\'"></div></div></md-content></div>\x3c!-- page footer --\x3e<div id=fine-print><ul class=horz-list><li><a title="NLM copyright information" href=http://www.nlm.nih.gov/copyright.html>Copyright</a></li><li><a title="NLM privacy policy" href=http://www.nlm.nih.gov/privacy.html>Privacy</a></li><li><a title="NLM accessibility" href=http://www.nlm.nih.gov/accessibility.html>Accessibility</a></li><li><a title="NIH Freedom of Information Act office" href=http://www.nih.gov/icd/od/foia/index.htm>Freedom of Information Act</a></li><li class=last-item><a title=USA.gov href=http://www.usa.gov/ ><img src=assets/images/USAgov.gif alt=USA.gov id=usagov></a></li></ul><ul class=horz-list><li><a title="U.S. National Library of Medicine" href=http://www.nlm.nih.gov/ >U.S. National Library of Medicine</a></li><li><a title="U.S. National Institutes of Health" href=http://www.nih.gov/ >U.S. National Institutes of Health</a></li><li class=last-item><a title="U.S. Department of Health and Human Services" href=http://www.hhs.gov/ >U.S. Department of Health and Human Services</a></li></ul></div>\x3c!-- end page footer --\x3e'),e.put("fhir-app/fhir-resource-dialog.html",'<md-dialog flex=50 ng-controller=FhirAppContentCtrl><form><md-toolbar><div class=md-toolbar-tools><h2 ng-bind-html=fhirResourceTitle></h2></div></md-toolbar><md-dialog-content><div><pre id=message-body ng-bind-html=fhirResourceString></pre></div></md-dialog-content><md-dialog-actions layout=row><md-button aria-label="Copy to clipboard" ng-click="copyToClipboard(\'message-body\')" class=md-primary>Copy to Clipboard</md-button><md-button id=close-res-dialog aria-label="Close dialog" ng-click=closeDialog() class=md-primary>Close</md-button></md-dialog-actions></form></md-dialog>'),e.put("fhir-app/fhir-server-select-dialog.html",'<md-dialog flex=45><form><md-toolbar><div class=md-toolbar-tools><h2 ng-bind-html=dialogTitle></h2></div></md-toolbar><md-dialog-content><div><p>{{dialogLabel}}</p><p>A list of <a href="http://wiki.hl7.org/index.php?title=Publicly_Available_FHIR_Servers_for_testing">FHIR server URLs</a> is available from HL7.</p><div layout=column ng-cloak><md-content layout-padding layout=column><form><input id=fhirServerURL ng-model=selectedServerInDialog autocomplete-lhc=fhirServerListOpts style="background-color: white"></form></md-content></div></div></md-dialog-content><md-dialog-actions layout=row><md-button id=btnOK aria-label=OK ng-click=confirmAndCloseDialog() class=md-primary>OK</md-button><md-button id=btnCancel aria-label=Cancel ng-click=closeDialog() class=md-primary>Cancel</md-button></md-dialog-actions></form></md-dialog>'),e.put("fhir-app/hl7-dialog.html",'<md-dialog flex=50 ng-controller=FhirAppContentCtrl><form><md-toolbar><div class=md-toolbar-tools><h2>HL7 OBR & OBX Segments</h2></div></md-toolbar><md-dialog-content><div><p>Please note that this is still a work in progress, and the code system values might be incorrect in some places.</p><pre id=message-body ng-bind-html=hl7String></pre></div></md-dialog-content><md-dialog-actions layout=row><md-button aria-label="Copy to clipboard" ng-click="copyToClipboard(\'message-body\')" class=md-primary>Copy to Clipboard</md-button><md-button aria-label="Close dialog" ng-click=closeDialog() class=md-primary>Close</md-button></md-dialog-actions></form></md-dialog>'),e.put("fhir-app/patient-select-dialog.html",'<md-dialog flex=45><form><md-toolbar><div class=md-toolbar-tools><h2 ng-bind-html=dialogTitle></h2></div></md-toolbar><md-dialog-content><div><p>{{dialogLabel}}</p><div layout=column ng-cloak><md-content layout-padding layout=column><form><md-autocomplete md-no-cache=false md-selected-item=selectedPatientInDialog md-search-text=patientSearchText md-items="item in searchPatientByName(patientSearchText)" md-item-text=item.name md-min-length=1 placeholder={{dialogHint}} md-menu-class=autocomplete-custom-template class=lf-patient-search><md-item-template><span class=item-title><span class="glyphicon glyphicon-user"></span> <span class=item-property><strong>{{item.name}} </strong></span></span><span class=item-metadata><span class=item-property>Gender: <strong>{{item.gender}}</strong> </span><span class=item-property>DoB: <strong>{{item.dob}}</strong> </span><span class=item-property>Phone: <strong>{{item.phone}}</strong></span></span></md-item-template><md-not-found>No patients found.</md-not-found></md-autocomplete></form></md-content></div></div></md-dialog-content><md-dialog-actions layout=row class=lost-data-warning ng-if="differentPatient(selectedPatient, selectedPatientInDialog)"><span>* Unsaved data in the form will be lost if you change to a different patient.</span> <span flex></span></md-dialog-actions><md-dialog-actions layout=row><md-button id=btnOK ng-if=selectedPatientInDialog aria-label=OK ng-click=confirmAndCloseDialog() class=md-primary>OK</md-button><md-button id=btnCancel aria-label=Cancel ng-click=closeDialog() class=md-primary>Cancel</md-button></md-dialog-actions></form></md-dialog>'),e.put("fhir-app/questionnaire-select-dialog.html",'<md-dialog flex=45><form><md-toolbar><div class=md-toolbar-tools><h2 ng-bind-html=dialogTitle></h2></div></md-toolbar><md-dialog-content><div><p>{{dialogLabel}}</p><div layout=column ng-cloak><md-content layout-padding layout=column><form><md-autocomplete md-no-cache=false md-selected-item=selectedQuestionnaireInDialog md-search-text=questionnaireSearchText md-items="item in searchQuestionnaireByName(questionnaireSearchText)" md-item-text=item.name md-min-length=1 placeholder={{dialogHint}} md-menu-class=autocomplete-custom-template class=lf-patient-search><md-item-template><span class=item-title><span class="glyphicon glyphicon-user"></span> <span class=item-property><strong>{{item.name}} </strong></span></span><span class=item-metadata><span class=item-property>Status: <strong>{{item.status}}</strong></span></span></md-item-template><md-not-found>No Questionnaires found.</md-not-found></md-autocomplete></form></md-content></div></div></md-dialog-content><md-dialog-actions layout=row class=lost-data-warning ng-if="differentQuestionnaire(selectedQuestionnaire, selectedQuestionnaireInDialog)"><span>* Unsaved data in the form will be lost if you choose a difference Questionnaire.</span> <span flex></span></md-dialog-actions><md-dialog-actions layout=row><md-button id=btnOK ng-if=selectedQuestionnaireInDialog aria-label=OK ng-click=confirmAndCloseDialog() class=md-primary>OK</md-button><md-button id=btnCancel aria-label=Cancel ng-click=closeDialog() class=md-primary>Cancel</md-button></md-dialog-actions></form></md-dialog>')}]);